<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ReviewHub – Rate Spotify albums & singles (0-10)</title>
  <meta name="description" content="Search or paste Spotify links for albums and singles, rate them 0-10, and share reviews with the community.">
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Login Modal -->
  <div id="loginModal" class="modal show">
    <div class="modal-content">
      <div class="modal-header">
        <div class="logo-small"></div>
        <h3>Welcome to ReviewHub</h3>
        <div class="sub">Rate and review your favorite albums & singles</div>
      </div>
      <div class="modal-body">
        <div class="auth-section">
          <div class="form-group">
            <label for="loginEmail">Email Address</label>
            <input id="loginEmail" type="email" placeholder="Enter your email" />
          </div>
          <div class="form-group">
            <label for="loginPassword">Password</label>
            <input id="loginPassword" type="password" placeholder="Enter your password" />
          </div>
          
          <!-- Registration fields -->
          <div id="registerFields" style="display:none;">
            <div class="form-group">
              <label for="registerUsername">Username</label>
              <input id="registerUsername" type="text" placeholder="Choose a username" />
              <div class="hint">This will be your public display name</div>
            </div>
            <div class="form-group">
              <label for="registerBio">Bio (optional)</label>
              <textarea id="registerBio" rows="3" placeholder="Tell us about yourself..."></textarea>
            </div>
          </div>
          
          <div class="auth-buttons">
            <button id="emailLoginBtn" class="btn primary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 4H4C2.9 4 2.01 4.9 2.01 6L2 18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 8L12 13L4 8V6L12 11L20 6V8Z"/>
              </svg>
              Sign In
            </button>
            
            <div class="auth-divider">
              <span>or</span>
            </div>
            
            <button id="emailRegisterBtn" class="btn ghost">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
              </svg>
              Create Account
            </button>
            
            <button id="switchToLogin" class="btn ghost small" style="display:none;">Back to Sign In</button>
          </div>
        </div>

        <div id="loginError" class="error-msg" style="display:none"></div>
      </div>
    </div>
  </div>

  <div class="app">
    <!-- User Bar -->
    <div id="userBar" class="user-bar" style="display:none">
      <div class="user-info">
        <img id="userAvatar" class="user-avatar clickable" src="" alt="">
        <span class="user-welcome">Welcome, <strong id="currentUser" class="clickable"></strong>!</span>
      </div>
      <button id="logoutBtn" class="btn ghost small">Logout</button>
    </div>

    <!-- Loading -->
    <div id="loadingApp" class="loading" style="display:none; justify-content:center; padding:40px;">
      <div class="spinner"></div>
      <span>Loading...</span>
    </div>

    <!-- Main App Content -->
    <div id="mainContent" style="display:none">
      <div class="brand">
        <div class="logo" aria-hidden></div>
        <div>
          <h1>ReviewHub</h1>
          <div class="sub">Search or paste Spotify links for albums and singles. Rate 0-10 and share with the community.</div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab" data-tab="add">Add Review</button>
        <button class="tab" data-tab="my-reviews">My Reviews</button>
        <button class="tab active" data-tab="global-feed">Global Feed</button>
        <button class="tab" data-tab="profile-view" style="display:none">Profile</button>
        <button class="tab" data-tab="about">About</button>
        <span class="right pill" id="statsPill">0 reviews</span>
      </div>

      <!-- Add Review Tab -->
      <section id="tab-add" class="grid" style="display:none">
        <div class="card">
          <div class="hd"><strong>Add a Review</strong></div>
          <div class="bd">
            <div class="row-1">
              <div>
                <label for="musicSearch">Search for music or paste Spotify link</label>
                <div class="search-container">
                  <input id="musicSearch" type="text" placeholder="Search for albums or singles..." />
                  <div id="searchSuggestions" class="search-suggestions" style="display:none"></div>
                </div>
                <div class="hint">Search by artist, album, or song name. Or paste any Spotify album/track URL.</div>
              </div>
            </div>

            <div class="spacer"></div>

            <div id="selectedMusic" style="display:none">
              <div class="r-card" style="margin-bottom:16px;">
                <img id="selectedCover" class="r-cover" alt="Cover" />
                <div>
                  <div id="selectedTitle" class="r-title"></div>
                  <div id="selectedArtist" class="r-artist"></div>
                  <div class="r-meta">
                    <span id="selectedType" class="tag"></span>
                    <div id="selectedGenres" class="genre-list"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="spacer"></div>

            <div class="row-1 row">
              <div class="rating">
                <label for="score">Score</label>
                <input id="score" type="range" min="0" max="10" step="0.01" value="5" />
                <span class="pill"><span>Current:</span> <strong id="scoreOut">5.00</strong>/10</span>
              </div>
              <div class="manual-score">
                <label for="manualScore">Or type exact score (0.00-10.00)</label>
                <input id="manualScore" type="number" min="0" max="10" step="0.01" placeholder="e.g., 8.74" />
              </div>
            </div>

            <div class="spacer"></div>

            <div class="row-1">
              <div>
                <label for="review">Your review</label>
                <textarea id="review" rows="5" placeholder="What did you think about this music?"></textarea>
              </div>
            </div>

            <div class="spacer"></div>

            <div class="toolbar">
              <button id="saveBtn" class="btn primary">Save Review</button>
              <button id="clearFormBtn" class="btn ghost">Clear</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd"><strong>Preview</strong></div>
          <div class="bd" id="previewPane">
            <div class="empty">Select music to see preview</div>
          </div>
        </div>
      </section>

      <!-- My Reviews Tab -->
      <section id="tab-my-reviews" style="display:none">
        <div class="card">
          <div class="hd">
            <strong>My Reviews</strong>
            <div class="toolbar">
              <button id="shareProfileBtn" class="btn small">Share Profile</button>
              <button id="exportBtn" class="btn small">Export</button>
            </div>
          </div>
          <div class="bd">
            <div class="filters">
              <div class="filter-group">
                <input id="mySearch" type="text" placeholder="Search my reviews...">
              </div>
              <div class="filter-group">
                <select id="mySortBy">
                  <option value="date-desc">Newest first</option>
                  <option value="date-asc">Oldest first</option>
                  <option value="score-desc">Highest rated</option>
                  <option value="score-asc">Lowest rated</option>
                  <option value="title-asc">Title A→Z</option>
                </select>
              </div>
            </div>
            <div id="myReviewsList" class="review-list"></div>
            <div id="myReviewsEmpty" class="empty" style="display:none">No reviews yet. Add one on the Add Review tab.</div>
          </div>
        </div>
      </section>

      <!-- Global Feed Tab -->
      <section id="tab-global-feed">
        <div class="card">
          <div class="hd">
            <strong>Global Feed</strong>
            <span class="pill" id="globalCount">0 reviews</span>
          </div>
          <div class="bd">
            <div class="filters">
              <div class="filter-group">
                <input id="globalSearch" type="text" placeholder="Search all reviews...">
              </div>
              <div class="filter-group">
                <select id="globalSortBy">
                  <option value="likes-desc">Most liked</option>
                  <option value="date-desc">Newest first</option>
                  <option value="score-desc">Highest rated</option>
                  <option value="score-asc">Lowest rated</option>
                </select>
              </div>
              <div class="filter-group">
                <select id="globalTypeFilter">
                  <option value="all">All types</option>
                  <option value="album">Albums only</option>
                  <option value="track">Singles only</option>
                </select>
              </div>
              <div class="filter-group">
                <select id="globalGenreFilter">
                  <option value="all">All genres</option>
                </select>
              </div>
            </div>
            <div id="globalReviewsList" class="review-list"></div>
            <div id="globalReviewsEmpty" class="empty" style="display:none">No reviews found.</div>
          </div>
        </div>
      </section>

      <!-- Profile View Tab -->
      <section id="tab-profile-view" style="display:none">
        <div class="card">
          <div class="hd">
            <div id="profileHeader">
              <img id="profileAvatar" class="profile-avatar" src="" alt="">
              <div class="profile-info">
                <h2 id="profileName">User</h2>
                <div id="profileBio" class="profile-bio"></div>
                <div id="profileStats" class="profile-stats"></div>
              </div>
            </div>
            <div id="profileActions" class="toolbar">
              <button id="editProfileBtn" class="btn small" style="display:none">Edit Profile</button>
              <button id="shareThisProfileBtn" class="btn small">Share Profile</button>
            </div>
          </div>
          <div class="bd">
            <div id="profileReviewsList" class="review-list"></div>
            <div id="profileReviewsEmpty" class="empty" style="display:none">No reviews found.</div>
          </div>
        </div>
      </section>

      <!-- About Tab -->
      <section id="tab-about" style="display:none">
        <div class="card">
          <div class="hd"><strong>About ReviewHub</strong></div>
          <div class="bd">
            <p><strong>ReviewHub</strong> is a community-driven platform for rating and reviewing music. Create an account to discover and share your thoughts on albums and singles.</p>
            <h3>Features:</h3>
            <ul>
              <li><strong>Spotify Integration:</strong> Search for music or paste Spotify links</li>
              <li><strong>Precise Ratings:</strong> Rate music from 0.00 to 10.00 with decimal precision</li>
              <li><strong>Community Feed:</strong> Discover reviews from other music lovers</li>
              <li><strong>Comments System:</strong> Engage with reviews through comments</li>
              <li><strong>User Profiles:</strong> Customize your profile with bio and avatar</li>
              <li><strong>Like System:</strong> Show appreciation for great reviews</li>
              <li><strong>Smart Filtering:</strong> Filter by genre, popularity, rating, and more</li>
              <li><strong>Cloud Sync:</strong> Your reviews are saved and accessible anywhere</li>
              <li><strong>Share Profile:</strong> Share your review collection with others</li>
            </ul>
            <p>Built with Supabase for real-time data and Spotify Web API for music discovery.</p>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Share Profile Modal -->
  <div id="shareModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Share Profile</h3>
        <button class="close-btn" id="closeShareModal">&times;</button>
      </div>
      <div class="modal-body">
        <p>Share this link to let others see this profile:</p>
        <div class="share-link-container">
          <input id="shareLink" type="text" readonly />
          <button id="copyLinkBtn" class="btn small">Copy</button>
        </div>
        <div id="copySuccess" class="success-msg" style="display:none">Link copied to clipboard!</div>
      </div>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div id="editProfileModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Profile</h3>
        <button class="close-btn" id="closeEditProfileModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="editUsername">Username</label>
          <input id="editUsername" type="text" placeholder="Your username" />
          <div class="hint" id="usernameHint">You can change your username every 3 days</div>
        </div>
        <div class="form-group">
          <label for="editBio">Bio</label>
          <textarea id="editBio" rows="4" placeholder="Tell us about yourself..."></textarea>
        </div>
        <div class="form-group">
          <label for="profilePicture">Profile Picture</label>
          <input id="profilePicture" type="file" accept="image/*" />
          <div class="hint">Upload an image file (JPG, PNG, GIF)</div>
        </div>
        <div class="toolbar">
          <button id="saveProfileBtn" class="btn primary">Save Changes</button>
          <button id="cancelEditProfileBtn" class="btn ghost">Cancel</button>
        </div>
        <div id="editProfileError" class="error-msg" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- Comments Modal -->
  <div id="commentsModal" class="modal">
    <div class="modal-content comments-modal">
      <div class="modal-header">
        <h3>Comments</h3>
        <button class="close-btn" id="closeCommentsModal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="reviewSummary" class="review-summary"></div>
        <div id="commentsList" class="comments-list"></div>
        <div id="addCommentSection" class="add-comment-section">
          <textarea id="newComment" rows="3" placeholder="Add a comment..."></textarea>
          <button id="postCommentBtn" class="btn primary small">Post Comment</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Album/Single Details Modal -->
  <div id="musicDetailsModal" class="modal">
    <div class="modal-content" style="max-width:600px;">
      <button id="closeMusicDetailsModal" class="close-btn">&times;</button>
      <div style="display:flex;gap:20px;align-items:flex-start;">
        <img id="musicDetailsCover" src="" alt="Cover" style="width:120px;height:120px;border-radius:12px;object-fit:cover;">
        <div>
          <div id="musicDetailsTitle" style="font-size:1.3em;font-weight:600;"></div>
          <div id="musicDetailsArtist" style="color:var(--muted);margin-bottom:4px;"></div>
          <div>
            <span id="musicDetailsType" class="tag"></span>
            <span id="musicDetailsRelease" class="tag"></span>
          </div>
          <div id="musicDetailsGenres" style="margin:8px 0;"></div>
          <div>Average Score: <span id="musicDetailsAvgScore">N/A</span></div>
        </div>
      </div>
      <div style="margin:16px 0;">
        <strong>Tracklist:</strong>
        <div id="musicDetailsTracklist" style="margin-top:4px;"></div>
      </div>
      <div style="margin:16px 0;">
        <strong>Reviews:</strong>
        <div id="musicDetailsReviews"></div>
      </div>
      <div style="margin:16px 0;">
        <input id="musicDetailsSearch" type="text" placeholder="Search for any album or single..." style="width:100%;padding:8px;">
        <div id="musicDetailsSearchResults" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="script.js"></script>
  <script>
    // album.js - Album Details Page Logic

    // --- CONFIG ---
    const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // <-- Replace with your Supabase URL
    const SUPABASE_KEY = 'YOUR_SUPABASE_KEY'; // <-- Replace with your Supabase anon key
    const SPOTIFY_TOKEN = 'YOUR_SPOTIFY_TOKEN'; // <-- Replace with your Spotify token logic

    // --- Supabase Client ---
    const supabase = window.supabase ? window.supabase : window.createClient?.(SUPABASE_URL, SUPABASE_KEY);

    // --- Helpers ---
    function getAlbumIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]));
    }

    function averageScore(reviews) {
      if (!reviews.length) return '-';
      const sum = reviews.reduce((acc, r) => acc + (parseFloat(r.score) || 0), 0);
      return (sum / reviews.length).toFixed(1);
    }

    // --- Fetch Album Details from Spotify ---
    async function fetchSpotifyAlbum(albumId) {
      const res = await fetch(`https://api.spotify.com/v1/albums/${albumId}`, {
        headers: { 'Authorization': `Bearer ${SPOTIFY_TOKEN}` }
      });
      if (!res.ok) return null;
      return await res.json();
    }

    // --- Fetch Reviews for Album from Supabase ---
    async function fetchReviews(albumId) {
      // You may need to adjust the table/column names
      const { data, error } = await supabase
        .from('reviews')
        .select('*')
        .eq('album_id', albumId);
      return data || [];
    }

    // --- Render Album Details Page ---
    async function renderAlbumDetailsPage() {
      const albumId = getAlbumIdFromUrl();
      if (!albumId) {
        document.getElementById('albumDetailsContainer').innerHTML = '<div class="empty">No album selected.</div>';
        return;
      }
      document.getElementById('albumDetailsContainer').innerHTML = '<div class="loading"><div class="spinner"></div> Loading album...</div>';

      // Fetch album and reviews
      const [album, reviews] = await Promise.all([
        fetchSpotifyAlbum(albumId),
        fetchReviews(albumId)
      ]);

      if (!album) {
        document.getElementById('albumDetailsContainer').innerHTML = '<div class="empty">Album not found.</div>';
        return;
      }

      // Render
      let avgScore = averageScore(reviews);
      let reviewSection = reviews.length ? `
        <div class="album-reviews">
          <div class="album-score-row">
            <span class="album-score">${avgScore}</span>
            <span class="album-score-label">Average Score</span>
          </div>
          <div class="album-review-list">
            ${reviews.map(r => `<div class="album-review-item">${escapeHtml(r.review_text)}</div>`).join('')}
          </div>
        </div>
      ` : '<div class="album-reviews"><div class="album-score-row"><span class="album-score">-</span><span class="album-score-label">No reviews yet</span></div></div>';

      document.getElementById('albumDetailsContainer').innerHTML = `
        <div class="album-details-header">
          <img src="${album.images[0]?.url || ''}" alt="${album.name}" class="album-details-thumb" />
          <div class="album-details-meta">
            <h3>${album.name}</h3>
            <div class="album-score-label">${album.album_type.charAt(0).toUpperCase() + album.album_type.slice(1)}</div>
            <div>${album.artists.map(a => a.name).join(', ')}</div>
            <div>${album.release_date?.slice(0,4) || ''}</div>
          </div>
        </div>
        <div class="album-tracklist">
          <h4>Tracklist</h4>
          <ol>
            ${album.tracks.items.map(t => `<li>${escapeHtml(t.name)}</li>`).join('')}
          </ol>
        </div>
        ${reviewSection}
      `;
    }

    // --- Run on page load ---
    window.addEventListener('DOMContentLoaded', renderAlbumDetailsPage);
  </script>
</body>
</html>
